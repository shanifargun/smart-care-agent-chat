<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Care Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:0;height:100vh;display:grid;grid-template-rows:auto 1fr auto}
    header{padding:12px 16px;border-bottom:1px solid #eee}
    #chat{padding:12px 16px;overflow:auto}
    .msg{margin:8px 0}
    .me{font-weight:600}
    .agent{white-space:pre-wrap}
    form{display:flex;gap:8px;padding:12px 16px;border-top:1px solid #eee}
    input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 16px;border:0;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <header><h3>Smart Care Agent</h3></header>
  <div id="chat"></div>
  <form id="f">
    <input id="msg" placeholder="Ask anything (e.g., Who is high risk today?)" />
    <button type="submit">Send</button>
  </form>

  <script>
    // API configuration
    const API = "https://smart-care-agent-chat.onrender.com/api/chat";
    const DBRX_PAT = ""; // This will be set by the backend
    
    // Add loading state
    let isLoading = false;

    const chat = document.getElementById("chat");
    const form = document.getElementById("f");
    const input = document.getElementById("msg");
    const messages = []; // keep full history

    function add(role, text){
      const d=document.createElement('div');
      d.className="msg " + (role==="user"?"me":"agent");
      d.textContent = (role==="user" ? "You: " : "Agent: ") + text;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send(content) {
      // Add user message to chat
      const userMessage = { role: "user", content };
      messages.push(userMessage);
      add("user", content);

      try {
        // Format messages for Databricks endpoint
        const formattedMessages = messages.map(msg => ({
          role: msg.role,
          content: msg.content
        }));

        const response = await fetch(API, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DBRX_PAT}`
          },
          body: JSON.stringify({
            messages: formattedMessages,
            temperature: 0.7,
            max_tokens: 500
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server error:', errorText);
          throw new Error(`Server responded with status ${response.status}: ${errorText}`);
        }

        const responseData = await response.json();
        console.log('Response data:', responseData);
        
        const text = responseData.output || 
                    responseData.response || 
                    (Array.isArray(responseData.predictions) && responseData.predictions[0]?.content) || 
                    JSON.stringify(responseData);
                    
        messages.push({role: "assistant", content: text});
        add("assistant", text);
      } catch (error) {
        console.error('Error sending message:', error);
        add("system", `Error: ${error.message}. Please check the browser console for more details.`);
      }
    }

    // Deep-link: ?patient_id=...
    const params = new URLSearchParams(location.search);
    const pid = params.get("patient_id");
    if (pid) {
      send(`Show a concise 360 for patient ${pid} and list the 5 most recent encounters. Then propose an outreach draft but do not send.`);
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || isLoading) return;
      
      // Disable form while loading
      isLoading = true;
      const button = form.querySelector('button');
      const buttonText = button.textContent;
      button.disabled = true;
      button.textContent = 'Sending...';
      
      try {
        await send(text);
      } catch (error) {
        console.error('Error:', error);
        add("system", `Error: ${error.message}`);
      } finally {
        // Re-enable form
        isLoading = false;
        button.disabled = false;
        button.textContent = buttonText;
        input.focus();
      }
      
      input.value = "";
    };
  </script>
</body>
</html>
